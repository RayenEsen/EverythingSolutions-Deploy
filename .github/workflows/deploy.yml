name: CI/CD Deploy EverythingSolutions

on:
  push:
    branches:
      - main     # Frontend triggers
      - master   # Backend triggers

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout Meta Repo (deployment repo itself)
      - name: Checkout Meta Repo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Checkout Frontend Repo
      - name: Checkout Frontend
        uses: actions/checkout@v3
        with:
          repository: RayenEsen/EverythingSolutions
          path: frontend
          ref: main
          token: ${{ secrets.DEPLOYMENT_PAT }}

      # 3Ô∏è‚É£ Checkout Backend Repo
      - name: Checkout Backend
        uses: actions/checkout@v3
        with:
          repository: RayenEsen/ES_Backend
          path: backend
          ref: master
          token: ${{ secrets.DEPLOYMENT_PAT }}

      # 4Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 5Ô∏è‚É£ Install Frontend Dependencies
      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm install

      # 6Ô∏è‚É£ Build Angular Frontend
      - name: Build Angular
        working-directory: frontend
        run: ng build ES --configuration=production

      # 7Ô∏è‚É£ Stop IIS Frontend Site
      - name: Stop IIS Frontend
        run: Stop-WebSite -Name "EverythingSolutions_Frontend" 

      # 8Ô∏è‚É£ Deploy Frontend to IIS
      - name: Deploy Frontend to IIS
        run: |
          Remove-Item -Recurse -Force "C:\inetpub\wwwroot\EverythingSolutions_Frontend\*" 
          Copy-Item -Path "frontend/dist/ES/*" -Destination "C:\inetpub\wwwroot\EverythingSolutions_Frontend" -Recurse

      # 9Ô∏è‚É£ Start IIS Frontend Site
      - name: Start IIS Frontend
        run: Start-WebSite -Name "EverythingSolutions_Frontend"

      # üîü Setup .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # 1Ô∏è‚É£1Ô∏è‚É£ Stop IIS Backend Site
      - name: Stop IIS Backend
        run: Stop-WebSite -Name "EverythingSolutions_webapi"

      # 1Ô∏è‚É£2Ô∏è‚É£ Restore & Build Backend
      - name: Restore & Build Backend
        working-directory: backend
        run: |
          dotnet restore ES_Backend.csproj
          dotnet publish ES_Backend.csproj --configuration Release --output "C:\Users\BLADE\Desktop\Work Folder\Production_ES\Backend\update"

      # 1Ô∏è‚É£3Ô∏è‚É£ Backup Production Database
      - name: Backup Production Database
        run: |
          $backupFile = "C:/Users/BLADE/Desktop/Work Folder/Production_ES/DB_Backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').bak"
          Invoke-Sqlcmd -ServerInstance "WIN-TBM17729TGQ\MSSQLSERVER01" -Database "EverythingSolutions_DB" -Query "BACKUP DATABASE [EverythingSolutions_DB] TO DISK = N'$backupFile' WITH NOFORMAT, INIT, NAME = 'DB-Full Backup', SKIP, NOREWIND, NOUNLOAD, STATS = 10"

      # 1Ô∏è‚É£4Ô∏è‚É£ Apply EF Core Migrations
      - name: Apply Database Migrations
        working-directory: backend
        run: dotnet ef database update --project ES_Backend.csproj --startup-project ES_Backend.csproj

      # 1Ô∏è‚É£5Ô∏è‚É£ Deploy Backend to IIS
      - name: Deploy Backend to IIS
        run: |
          Remove-Item -Recurse -Force "C:\inetpub\wwwroot\EverythingSolutions_webapi\*" 
          Copy-Item -Path "C:\Users\BLADE\Desktop\Work Folder\Production_ES\Backend\update\*" -Destination "C:\inetpub\wwwroot\EverythingSolutions_webapi" -Recurse

      # 1Ô∏è‚É£6Ô∏è‚É£ Start IIS Backend Site
      - name: Start IIS Backend
        run: Start-WebSite -Name "EverythingSolutions_webapi"
