name: CI/CD Deploy EverythingSolutions (Debug)

on:
  push:
    branches:
      - main     # Frontend
      - master   # Backend

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout Meta Repo (current repo)
      - name: Checkout Meta Repo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Pull Frontend repo (always from main)
      - name: Checkout Frontend
        uses: actions/checkout@v3
        with:
          repository: RayenEsen/EverythingSolutions
          path: frontend
          ref: main

      # 3Ô∏è‚É£ Pull Backend repo (always from master)
      - name: Checkout Backend
        uses: actions/checkout@v3
        with:
          repository: RayenEsen/ES_Backend
          path: backend
          ref: master

      # üîç Debug Node.js / npm versions
      - name: Debug Node.js & npm
        run: |
          node -v
          npm -v
          echo "Working directory:"
          pwd
          echo "Repo structure:"
          ls -la

      # 4Ô∏è‚É£ Setup Node.js for Angular
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 5Ô∏è‚É£ Install Angular dependencies
      - name: Install Frontend Dependencies
        working-directory: frontend
        run: |
          npm install
          echo "Frontend deps installed"
          ls -la

      # 6Ô∏è‚É£ Build Angular frontend (production config)
      - name: Build Angular
        working-directory: frontend
        run: |
          npx ng version
          npx ng build ES --configuration=production
          echo "‚úÖ Angular build finished"
          echo "üìÇ Dist content:"
          ls -la dist

      # üîç Debug Dist Folder
      - name: Debug Angular Dist
        working-directory: frontend/dist
        run: ls -la

      # 7Ô∏è‚É£ Stop IIS Frontend Site
      - name: Stop IIS Frontend
        run: Stop-WebSite -Name "EverythingSolutions_Frontend" 

      # 8Ô∏è‚É£ Deploy Frontend to IIS
      - name: Deploy Frontend to IIS
        run: |
          echo "Clearing old IIS frontend files..."
          Remove-Item -Recurse -Force "C:\inetpub\wwwroot\EverythingSolutions_Frontend\*" 
          echo "Copying new frontend build..."
          Copy-Item -Path "frontend/dist/ES/*" -Destination "C:\inetpub\wwwroot\EverythingSolutions_Frontend" -Recurse
          echo "‚úÖ Frontend deployed"

      # 9Ô∏è‚É£ Start IIS Frontend Site
      - name: Start IIS Frontend
        run: Start-WebSite -Name "EverythingSolutions_Frontend"

      # üîü Setup .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # 1Ô∏è‚É£1Ô∏è‚É£ Stop IIS Backend Site
      - name: Stop IIS Backend
        run: Stop-WebSite -Name "EverythingSolutions_webapi"

      # 1Ô∏è‚É£2Ô∏è‚É£ Restore & Build Backend
      - name: Restore & Build Backend
        working-directory: backend
        run: |
          dotnet --version
          dotnet restore ES_Backend.csproj
          dotnet publish ES_Backend.csproj --configuration Release --output "C:\Users\BLADE\Desktop\Work Folder\Production_ES\Backend\update"
          echo "‚úÖ Backend published"

      # üîç Debug Backend Build
      - name: Debug Backend Build
        run: |
          echo "Backend output content:"
          ls -la "C:\Users\BLADE\Desktop\Work Folder\Production_ES\Backend\update"

      # 1Ô∏è‚É£3Ô∏è‚É£ Backup Production Database
      - name: Backup Production Database
        run: |
          $backupFile = "C:/Users/BLADE/Desktop/Work Folder/Production_ES/DB_Backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').bak"
          echo "Backing up DB to $backupFile"
          Invoke-Sqlcmd -ServerInstance "WIN-TBM17729TGQ\MSSQLSERVER01" -Database "EverythingSolutions_DB" -Query "BACKUP DATABASE [EverythingSolutions_DB] TO DISK = N'$backupFile' WITH NOFORMAT, INIT, NAME = 'DB-Full Backup', SKIP, NOREWIND, NOUNLOAD, STATS = 10"

      # 1Ô∏è‚É£4Ô∏è‚É£ Apply EF Core Migrations
      - name: Apply Database Migrations
        working-directory: backend
        run: |
          dotnet ef database update --project ES_Backend.csproj --startup-project ES_Backend.csproj
          echo "‚úÖ Migrations applied"

      # 1Ô∏è‚É£5Ô∏è‚É£ Deploy Backend to IIS
      - name: Deploy Backend to IIS
        run: |
          echo "Clearing old backend files..."
          Remove-Item -Recurse -Force "C:\inetpub\wwwroot\EverythingSolutions_webapi\*" 
          echo "Copying new backend build..."
          Copy-Item -Path "C:\Users\BLADE\Desktop\Work Folder\Production_ES\Backend\update\*" -Destination "C:\inetpub\wwwroot\EverythingSolutions_webapi" -Recurse
          echo "‚úÖ Backend deployed"

      # 1Ô∏è‚É£6Ô∏è‚É£ Start IIS Backend Site
      - name: Start IIS Backend
        run: Start-WebSite -Name "EverythingSolutions_webapi"
