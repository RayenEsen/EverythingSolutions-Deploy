name: CI/CD Deploy EverythingSolutions

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout the meta repo (current repo)
      - name: Checkout Meta Repo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Pull Frontend repo
      - name: Checkout Frontend
        uses: actions/checkout@v3
        with:
          repository: RayenEsen/EverythingSolutions
          path: frontend

      # 3Ô∏è‚É£ Pull Backend repo
      - name: Checkout Backend
        uses: actions/checkout@v3
        with:
          repository: RayenEsen/ES_Backend
          path: backend

      # 4Ô∏è‚É£ Setup Node.js for Angular
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 5Ô∏è‚É£ Install Angular dependencies
      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm install

      # 6Ô∏è‚É£ Build Angular frontend
      - name: Build Angular
        working-directory: frontend
        run: npm run build -- --prod

      # 7Ô∏è‚É£ Setup .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # 8Ô∏è‚É£ Restore and build .NET backend
      - name: Restore & Build Backend
        working-directory: backend
        run: |
          dotnet restore ES_Backend.csproj
          dotnet build ES_Backend.csproj --configuration Release

      # 9Ô∏è‚É£ Apply EF Core Migrations
      - name: Apply Database Migrations
        working-directory: backend
        run: |
          dotnet ef database update --project ES_Backend.csproj --startup-project ES_Backend.csproj

      # üîü Deploy Frontend to IIS
      - name: Deploy Frontend to IIS
        run: |
          Remove-Item -Recurse -Force "C:\inetpub\wwwroot\EverythingSolutions_Frontend\*" 
          Copy-Item -Path "frontend\dist\*" -Destination "C:\inetpub\wwwroot\EverythingSolutions_Frontend" -Recurse

      # 1Ô∏è‚É£1Ô∏è‚É£ Deploy Backend to IIS
      - name: Deploy Backend to IIS
        run: |
          Remove-Item -Recurse -Force "C:\inetpub\wwwroot\EverythingSolutions_webapi\*" 
          Copy-Item -Path "backend\bin\Release\net8.0\publish\*" -Destination "C:\inetpub\wwwroot\EverythingSolutions_webapi" -Recurse
